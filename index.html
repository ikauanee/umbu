<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cadastro de NFe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 40px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px 0;
            margin-bottom: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .demo-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--accent-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
            border: none;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: #27ae60;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .section-title {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .form-control {
            border-radius: 8px;
            padding: 12px 15px;
            border: 2px solid #ddd;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        #qrcode {
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            display: inline-block;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .product-item {
            border-left: 4px solid var(--secondary-color);
            padding-left: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .product-item:hover {
            border-left-color: var(--accent-color);
            background-color: #f8f9fa;
        }
        
        .nav-tabs .nav-link {
            color: var(--primary-color);
            font-weight: 600;
            border-radius: 8px 8px 0 0;
            padding: 12px 25px;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background-color: #27ae60;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.5s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .tab-content {
            padding: 25px;
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .footer {
            text-align: center;
            padding: 20px 0;
            margin-top: 40px;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert-prototipo {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeeba;
            font-weight: 500;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <div class="demo-badge">Modo Demonstração</div>
        <div class="container">
            <h1 class="display-4">Sistema de Cadastro de NFe</h1>
            <p class="lead">Sistema completo para cadastro de Notas Fiscais Eletrônicas</p>
        </div>
    </div>

    <div class="container">
        <div class="alert alert-prototipo" role="alert">
            ⚠️ Este é apenas um protótipo para demonstração. Os dados exibidos não correspondem a notas fiscais reais.
        </div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab">Início</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro" type="button" role="tab">Cadastrar NFe</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="visualizar-tab" data-bs-toggle="tab" data-bs-target="#visualizar" type="button" role="tab">NFe Cadastradas</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="qrcode-tab" data-bs-toggle="tab" data-bs-target="#qrcode-section" type="button" role="tab">Gerar QR Code</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="caixa-tab" data-bs-toggle="tab" data-bs-target="#caixa-section" type="button" role="tab">Gerar QR Code da Caixa</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel">
                <div class="row">
                    <div class="col-md-8 mx-auto text-center">
                        <h2 class="section-title">Sistema de Cadastro de NFe</h2>
                        <p class="lead">Sistema completo para cadastro, gerenciamento de Notas Fiscais Eletrônicas e geração de QR Code para caixas/lotes.</p>
                        
                        <div class="row mt-5">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-clipboard-plus" viewBox="0 0 16 16" style="color: var(--secondary-color);">
                                                <path fill-rule="evenodd" d="M8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7z"/>
                                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                                            </svg>
                                        </div>
                                        <h5>Cadastrar NFe</h5>
                                        <p>Cadastre notas fiscais usando a chave de acesso.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-list-check" viewBox="0 0 16 16" style="color: var(--secondary-color);">
                                                <path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3.854 2.146a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 1 1 .708-.708L2 3.293l1.146-1.147a.5.5 0 0 1 .708 0zm0 4a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 1 1 .708-.708L2 7.293l1.146-1.147a.5.5 0 0 1 .708 0zm0 4a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 0 1 .708-.708l.146.147 1.146-1.147a.5.5 0 0 1 .708 0z"/>
                                            </svg>
                                        </div>
                                        <h5>Visualizar NFe</h5>
                                        <p>Visualize todas as NFe cadastradas no sistema.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-qr-code" viewBox="0 0 16 16" style="color: var(--secondary-color);">
                                                <path d="M2 2h2v2H2V2Z"/><path d="M6 0v6H0V0h6ZM5 1H1v4h4V1ZM4 12H2v2h2v-2Z"/><path d="M6 10v6H0v-6h6Zm-5 1v4h4v-4H1Zm11-9h2v2h-2V2Z"/><path d="M10 0v6h6V0h-6Zm5 1v4h-4V1h4ZM8 1V0h1v2H8v2H7V1h1Zm0 5V4h1v2H8ZM6 8V7h1V6h1v2h1V7h5v1h-4v1H7V8H6Zm0 0v1H2V8H1v1H0V7h3v1h3Zm10 1h-1V7h1v2Zm-1 0h-1v2h2v-1h-1V9Zm-4 0h2v1h-1v1h-1V9Zm2 3v-1h-1v1h-1v1H9v1h3v-2h1Zm0 0h3v1h-2v1h-1v-2Zm-4-1v1h1v-2H7v1h2Z"/><path d="M7 12h1v3h4v1H7v-4Zm9 2v2h-3v-1h2v-1h1Z"/>
                                            </svg>
                                        </div>
                                        <h5>Gerar QR Code</h5>
                                        <p>Gere QR codes com os produtos das NFe ou caixas.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-5">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Chaves de Exemplo para Teste</h5>
                            </div>
                            <div class="card-body">
                                <p>Use estas chaves fictícias para testar o sistema de cadastro:</p>
                                <ul class="list-group">
                                    <li class="list-group-item"><code>35240801234567000123550010000000011000000016</code> - Nota Fiscal Eletrônica simples</li>
                                    <li class="list-group-item"><code>35240801234567000123550010000000021000000017</code> - Nota com múltiplos produtos</li>
                                    <li class="list-group-item"><code>35240801234567000123550010000000031000000018</code> - Nota com valor alto</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="cadastro" role="tabpanel">
                <h2 class="section-title">Cadastrar NFe por Chave</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Cadastrar NFe</div>
                            <div class="card-body">
                                <form id="codigoForm">
                                    <div class="mb-3">
                                        <label for="codigoNFe" class="form-label">Chave da NFe</label>
                                        <input type="text" class="form-control" id="codigoNFe" placeholder="Digite a chave de acesso (44 dígitos) da NFe" required>
                                        <div class="form-text">Use as chaves de exemplo ou uma chave real de 44 dígitos.</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary" id="btnCadastrar">
                                        <span class="btn-text">Cadastrar NFe</span>
                                        <span class="loading" style="display: none;"></span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Informações da NFe</div>
                            <div class="card-body">
                                <div id="nfeInfo" class="p-3" style="display: none;">
                                    <h5>Dados da Nota Fiscal</h5>
                                    <p><strong>Número:</strong> <span id="infoNumero">-</span></p>
                                    <p><strong>Data de Emissão:</strong> <span id="infoData">-</span></p>
                                    <p><strong>Emitente:</strong> <span id="infoEmitente">-</span></p>
                                    <p><strong>CNPJ Emitente:</strong> <span id="infoCnpjEmitente">-</span></p>
                                    <p><strong>Destinatário:</strong> <span id="infoDestinatario">-</span></p>
                                    <p><strong>CNPJ/CPF Destinatário:</strong> <span id="infoCnpjDestinatario">-</span></p>
                                    <p><strong>Valor Total:</strong> R$ <span id="infoValor">-</span></p>
                                    <p><strong>Chave de Acesso:</strong> <span id="infoChave">-</span></p>
                                    <p><strong>Status:</strong> <span class="badge bg-success" id="infoStatus">Cadastro realizado</span></p>
                                    <h6 class="mt-3">Produtos</h6>
                                    <div id="infoProdutos"></div>
                                </div>
                                <div id="noNfeInfo" class="text-center p-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-receipt" viewBox="0 0 16 16" style="color: #ccc;">
                                        <path d="M1.92.506a.5.5 0 0 1 .434.14L3 1.293l.646-.647a.5.5 0 0 1 .708 0L5 1.293l.646-.647a.5.5 0 0 1 .708 0L7 1.293l.646-.647a.5.5 0 0 1 .708 0L9 1.293l.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .801.13l.5 1A.5.5 0 0 1 15 2v12a.5.5 0 0 1-.053.224l-.5 1a.5.5 0 0 1-.8.13L13 14.707l-.646.647a.5.5 0 0 1-.708 0L11 14.707l-.646.647a.5.5 0 0 1-.708 0L9 14.707l-.646.647a.5.5 0 0 1-.708 0L7 14.707l-.646.647a.5.5 0 0 1-.708 0L5 14.707l-.646.647a.5.5 0 0 1-.708 0L3 14.707l-.646.647a.5.5 0 0 1-.801-.13l-.5-1A.5.5 0 0 1 1 14V2a.5.5 0 0 1 .053-.224l.5-1a.5.5 0 0 1 .367-.27zm.902 13.65a.5.5 0 0 0 .684-.12L3 13.793l.646.647a.5.5 0 0 0 .708 0L5 13.793l.646.647a.5.5 0 0 0 .708 0L7 13.793l.646.647a.5.5 0 0 0 .708 0L9 13.793l.646.647a.5.5 0 0 0 .708 0l.646-.647.646.647a.5.5 0 0 0 .801-.13l.5-1a.5.5 0 0 0-.053-.224L14 2.207l-.646.647a.5.5 0 0 1-.708 0L12 2.207l-.646.647a.5.5 0 0 1-.708 0L10 2.207l-.646.647a.5.5 0 0 1-.708 0L8 2.207l-.646.647a.5.5 0 0 1-.708 0L6 2.207l-.646.647a.5.5 0 0 1-.708 0L4 2.207l-.646.647a.5.5 0 0 1-.708 0L2 2.207l-.646.647a.5.5 0 0 0-.12.684l.5 1a.5.5 0 0 0 .13.801l.5-.5.5.5a.5.5 0 0 0 .8-.13l.5-1a.5.5 0 0 0-.053-.224l.5-.5.5.5a.5.5 0 0 0 .8-.13l.5-1a.5.5 0 0 0-.053-.224l.5-.5.5.5a.5.5 0 0 0 .8-.13l.5-1a.5.5 0 0 0-.053-.224l.5-.5.5.5a.5.5 0 0 0 .8-.13l.5-1z"/>
                                    </svg>
                                    <p class="mt-3 text-muted">Nenhuma informação de NFe disponível. Cadastre uma NFe para visualizar os dados.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="visualizar" role="tabpanel">
                <h2 class="section-title">NFe Cadastradas no Sistema</h2>
                <div class="card">
                    <div class="card-header">NFe Armazenadas</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Emitente</th>
                                        <th>Data Emissão</th>
                                        <th>Valor Total</th>
                                        <th>Chave de Acesso</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="nfeList">
                                    <tr>
                                        <td colspan="6" class="text-center">Nenhuma NFe cadastrada ainda</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="qrcode-section" role="tabpanel">
                <h2 class="section-title">Gerar QR Code para Produtos</h2>
                <div class="card">
                    <div class="card-header">Seleção de NFe e Produtos</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="selectNFe" class="form-label">Selecionar NFe:</label>
                                    <select class="form-control" id="selectNFe">
                                        <option value="">Selecione uma NFe</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="produtosCheckboxes" class="mb-3" style="display: none;">
                            <h5>Selecione os produtos para incluir no QR Code:</h5>
                            <div id="produtosList" class="row"></div>
                            <button type="button" class="btn btn-success mt-3" id="gerarQrCode">Gerar QR Code</button>
                        </div>

                        <div class="text-center mt-4">
                            <div id="qrcode"></div>
                            <div id="qrInfo" class="mt-3"></div>
                            <button id="downloadQr" class="btn btn-primary mt-3" style="display: none;">Download QR Code</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="caixa-section" role="tabpanel">
                <h2 class="section-title">Gerar QR Code da Caixa</h2>
                <div class="card">
                    <div class="card-header">Seleção de Notas Fiscais</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h5>Selecione as NFes para incluir no QR Code da Caixa:</h5>
                            <div id="caixaNFeList" class="row"></div>
                            <button type="button" class="btn btn-success mt-3" id="gerarQrCaixa">Gerar QR Code da Caixa</button>
                        </div>
                        <div class="text-center mt-4">
                            <div id="qrcodeCaixa"></div>
                            <div id="qrCaixaInfo" class="mt-3"></div>
                            <button id="downloadQrCaixa" class="btn btn-primary mt-3" style="display: none;">Download QR Code da Caixa</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <p>Sistema de Cadastro de NFe &copy; 2025 - Modo Demonstração</p>
        </div>
    </div>

    <div class="notification" id="notification">Operação realizada com sucesso!</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Armazenamento de notas fiscais
        let nfeRecords = JSON.parse(localStorage.getItem('nfeRecords')) || [];
        let nextId = nfeRecords.length > 0 ? Math.max(...nfeRecords.map(nfe => nfe.id)) + 1 : 4;

        // Mostrar notificação
        function showNotification(message, isSuccess = true) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = isSuccess ? '#27ae60' : '#e74c3c';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Formulário de cadastro de NFe
        document.getElementById('codigoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const codigo = document.getElementById('codigoNFe').value.trim();
            const btnCadastrar = document.getElementById('btnCadastrar');
            const btnText = btnCadastrar.querySelector('.btn-text');
            const loading = btnCadastrar.querySelector('.loading');
            
            if (!codigo) {
                showNotification('Por favor, insira uma chave válida.', false);
                return;
            }
            
            // Mostrar loading
            btnText.style.display = 'none';
            loading.style.display = 'inline-block';
            btnCadastrar.disabled = true;
            
            // Consultar API ou usar dados fictícios
            fetch('/api/cadastrar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codigo: codigo })
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`Erro HTTP: ${res.status} ${res.statusText}`);
                }
                return res.json();
            })
            .then(data => {
                if (data.error) {
                    showNotification(data.error, false);
                    return;
                }
                
                // Verificar se já existe
                if (nfeRecords.some(record => record.chaveAcesso === data.chaveAcesso)) {
                    showNotification('Esta NFe já está cadastrada no sistema.', false);
                    return;
                }
                
                // Adicionar ID único
                const nfeComId = {...data, id: nextId++};
                nfeRecords.push(nfeComId);
                localStorage.setItem('nfeRecords', JSON.stringify(nfeRecords));
                
                // Exibir informações
                document.getElementById('infoNumero').textContent = nfeComId.numero;
                document.getElementById('infoData').textContent = new Date(nfeComId.dataEmissao).toLocaleDateString('pt-BR');
                document.getElementById('infoEmitente').textContent = nfeComId.nomeEmitente;
                document.getElementById('infoCnpjEmitente').textContent = nfeComId.cnpjEmitente;
                document.getElementById('infoDestinatario').textContent = nfeComId.nomeDestinatario;
                document.getElementById('infoCnpjDestinatario').textContent = nfeComId.cnpjDestinatario;
                document.getElementById('infoValor').textContent = nfeComId.valorTotal.toFixed(2);
                document.getElementById('infoChave').textContent = nfeComId.chaveAcesso;
                
                // Exibir produtos
                const produtosHtml = nfeComId.produtos.length > 0 ? `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Descrição</th>
                                <th>Quantidade</th>
                                <th>Valor Unitário</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${nfeComId.produtos.map(produto => `
                                <tr>
                                    <td>${produto.codigo || 'N/A'}</td>
                                    <td>${produto.descricao || produto.nome || 'N/A'}</td>
                                    <td>${produto.quantidade || 'N/A'}</td>
                                    <td>R$ ${(produto.valorUnitario || produto.valor_unitario || 0).toFixed(2)}</td>
                                    <td>R$ ${((produto.quantidade || 0) * (produto.valorUnitario || produto.valor_unitario || 0)).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>Nenhum produto encontrado.</p>';
                document.getElementById('infoProdutos').innerHTML = produtosHtml;
                
                document.getElementById('noNfeInfo').style.display = 'none';
                document.getElementById('nfeInfo').style.display = 'block';
                
                showNotification('NFe cadastrada com sucesso! Status: Cadastro realizado');
                
                // Atualizar listas
                atualizarListaNFe();
                atualizarSelectNFe();
                atualizarCaixaNFeList();
            })
            .catch(err => {
                showNotification(`Erro ao cadastrar: ${err.message}`, false);
            })
            .finally(() => {
                btnText.style.display = 'inline-block';
                loading.style.display = 'none';
                btnCadastrar.disabled = false;
            });
        });

        // Atualizar lista de NFe
        function atualizarListaNFe() {
            const nfeList = document.getElementById('nfeList');
            nfeList.innerHTML = '';
            
            if (nfeRecords.length === 0) {
                nfeList.innerHTML = '<tr><td colspan="6" class="text-center">Nenhuma NFe cadastrada ainda</td></tr>';
                return;
            }
            
            nfeRecords.forEach(nfe => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${nfe.numero}</td>
                    <td>${nfe.nomeEmitente}</td>
                    <td>${new Date(nfe.dataEmissao).toLocaleDateString('pt-BR')}</td>
                    <td>R$ ${nfe.valorTotal.toFixed(2)}</td>
                    <td>${nfe.chaveAcesso}</td>
                    <td>
                        <button class="btn btn-sm btn-info btn-visualizar" data-id="${nfe.id}">Visualizar</button>
                        <button class="btn btn-sm btn-danger btn-remover" data-id="${nfe.id}">Remover</button>
                    </td>
                `;
                nfeList.appendChild(tr);
            });
            
            // Adicionar event listeners
            document.querySelectorAll('.btn-visualizar').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-id'));
                    const nfe = nfeRecords.find(record => record.id === id);
                    exibirDetalhesNFe(nfe);
                });
            });
            
            document.querySelectorAll('.btn-remover').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-id'));
                    removerNFe(id);
                });
            });
        }

        // Exibir detalhes da NFe
        function exibirDetalhesNFe(nfe) {
            const produtosHtml = nfe.produtos.length > 0 ? `
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Descrição</th>
                            <th>Quantidade</th>
                            <th>Valor Unitário</th>
                            <th>Valor Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${nfe.produtos.map(produto => `
                            <tr>
                                <td>${produto.codigo || 'N/A'}</td>
                                <td>${produto.descricao || produto.nome || 'N/A'}</td>
                                <td>${produto.quantidade || 'N/A'}</td>
                                <td>R$ ${(produto.valorUnitario || produto.valor_unitario || 0).toFixed(2)}</td>
                                <td>R$ ${((produto.quantidade || 0) * (produto.valorUnitario || produto.valor_unitario || 0)).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p>Nenhum produto encontrado.</p>';

            const modalHtml = `
                <div class="modal fade" id="detalhesNFeModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Detalhes da NFe ${nfe.numero}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Número:</strong> ${nfe.numero}</p>
                                        <p><strong>Data de Emissão:</strong> ${new Date(nfe.dataEmissao).toLocaleDateString('pt-BR')}</p>
                                        <p><strong>Emitente:</strong> ${nfe.nomeEmitente}</p>
                                        <p><strong>CNPJ Emitente:</strong> ${nfe.cnpjEmitente}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Destinatário:</strong> ${nfe.nomeDestinatario}</p>
                                        <p><strong>CNPJ/CPF Destinatário:</strong> ${nfe.cnpjDestinatario}</p>
                                        <p><strong>Valor Total:</strong> R$ ${nfe.valorTotal.toFixed(2)}</p>
                                        <p><strong>Chave de Acesso:</strong> ${nfe.chaveAcesso}</p>
                                    </div>
                                </div>
                                <h5 class="mt-4">Produtos</h5>
                                ${produtosHtml}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('detalhesNFeModal'));
            modal.show();
            document.getElementById('detalhesNFeModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Remover NFe
        function removerNFe(id) {
            if (confirm('Tem certeza que deseja remover esta NFe?')) {
                nfeRecords = nfeRecords.filter(record => record.id !== id);
                localStorage.setItem('nfeRecords', JSON.stringify(nfeRecords));
                showNotification('NFe removida com sucesso!');
                atualizarListaNFe();
                atualizarSelectNFe();
                atualizarCaixaNFeList();
            }
        }

        // Atualizar select de NFe para a aba de QR Code
        function atualizarSelectNFe() {
            const select = document.getElementById('selectNFe');
            select.innerHTML = '<option value="">Selecione uma NFe</option>';
            
            nfeRecords.forEach((nfe) => {
                const option = document.createElement('option');
                option.value = nfe.id;
                option.textContent = `NFe ${nfe.numero} - ${nfe.nomeEmitente}`;
                select.appendChild(option);
            });
        }

        // Atualizar lista de NFes para a aba de Caixa
        function atualizarCaixaNFeList() {
            const caixaNFeList = document.getElementById('caixaNFeList');
            caixaNFeList.innerHTML = '';
            
            if (nfeRecords.length === 0) {
                caixaNFeList.innerHTML = '<p class="text-center">Nenhuma NFe cadastrada para gerar QR Code da caixa.</p>';
                return;
            }
            
            nfeRecords.forEach((nfe, i) => {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                col.innerHTML = `
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="${nfe.id}" id="caixaNFe${i}" checked>
                        <label class="form-check-label" for="caixaNFe${i}">
                            <strong>NFe ${nfe.numero}</strong> - ${nfe.nomeEmitente}<br>
                            <small>Valor: R$ ${nfe.valorTotal.toFixed(2)} | Data: ${new Date(nfe.dataEmissao).toLocaleDateString('pt-BR')}</small>
                        </label>
                    </div>
                `;
                caixaNFeList.appendChild(col);
            });
        }

        // Quando selecionar uma NFe para gerar QR Code
        document.getElementById('selectNFe').addEventListener('change', function() {
            const id = parseInt(this.value);
            const produtosList = document.getElementById('produtosList');
            produtosList.innerHTML = '';
            
            if (id) {
                const nfe = nfeRecords.find(record => record.id === id);
                
                if (nfe) {
                    nfe.produtos.forEach((produto, i) => {
                        const col = document.createElement('div');
                        col.className = 'col-md-6';
                        col.innerHTML = `
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" value="${i}" id="produto${i}" checked>
                                <label class="form-check-label" for="produto${i}">
                                    <strong>${produto.codigo || 'N/A'}</strong> - ${produto.descricao || produto.nome || 'N/A'}<br>
                                    <small>Quantidade: ${produto.quantidade || 'N/A'} | Valor: R$ ${(produto.valorUnitario || produto.valor_unitario || 0).toFixed(2)}</small>
                                </label>
                            </div>
                        `;
                        produtosList.appendChild(col);
                    });
                    document.getElementById('produtosCheckboxes').style.display = 'block';
                }
            } else {
                document.getElementById('produtosCheckboxes').style.display = 'none';
            }
        });

        // Gerar QR Code para produtos
        document.getElementById('gerarQrCode').addEventListener('click', function() {
            const id = parseInt(document.getElementById('selectNFe').value);
            if (!id) {
                showNotification('Selecione uma NFe primeiro!', false);
                return;
            }
            
            const nfe = nfeRecords.find(record => record.id === id);
            const checkboxes = document.querySelectorAll('#produtosList input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                showNotification('Selecione pelo menos um produto!', false);
                return;
            }
            
            // Coletar produtos selecionados
            const produtosSelecionados = [];
            checkboxes.forEach(checkbox => {
                const produtoIndex = parseInt(checkbox.value);
                produtosSelecionados.push(nfe.produtos[produtoIndex]);
            });
            
            // Criar dados para o QR Code (mais completos)
            const qrData = {
                nfe: nfe.numero,
                chaveAcesso: nfe.chaveAcesso,
                dataEmissao: nfe.dataEmissao,
                nomeEmitente: nfe.nomeEmitente,
                valorTotal: nfe.valorTotal,
                produtos: produtosSelecionados.map(prod => ({
                    codigo: prod.codigo || 'N/A',
                    descricao: prod.descricao || prod.nome || 'N/A',
                    quantidade: prod.quantidade || 0,
                    valorUnitario: prod.valorUnitario || prod.valor_unitario || 0
                }))
            };
            
            const qrDataString = JSON.stringify(qrData);
            
            // Gerar QR Code
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: qrDataString,
                width: 200,
                height: 200
            });
            
            document.getElementById('qrInfo').textContent = `QR Code gerado para ${produtosSelecionados.length} produtos da NFe ${nfe.numero} - ${nfe.nomeEmitente} (R$ ${nfe.valorTotal.toFixed(2)})`;
            document.getElementById('downloadQr').style.display = 'inline-block';
            
            // Configurar download do QR Code
            document.getElementById('downloadQr').onclick = function() {
                const canvas = qrContainer.querySelector('canvas');
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `qrcode-nfe-${nfe.numero}.png`;
                link.href = url;
                link.click();
            };
            
            showNotification('QR Code gerado com sucesso!');
        });

        // Gerar QR Code da Caixa
        document.getElementById('gerarQrCaixa').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('#caixaNFeList input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                showNotification('Selecione pelo menos uma NFe!', false);
                return;
            }
            
            // Coletar NFes selecionadas
            const nfeSelecionadas = [];
            let valorTotalCaixa = 0;
            checkboxes.forEach(checkbox => {
                const nfeId = parseInt(checkbox.value);
                const nfe = nfeRecords.find(record => record.id === nfeId);
                nfeSelecionadas.push({
                    numero: nfe.numero,
                    chaveAcesso: nfe.chaveAcesso,
                    nomeEmitente: nfe.nomeEmitente,
                    valorTotal: nfe.valorTotal,
                    produtos: nfe.produtos.map(prod => ({
                        codigo: prod.codigo || 'N/A',
                        descricao: prod.descricao || prod.nome || 'N/A',
                        quantidade: prod.quantidade || 0,
                        valorUnitario: prod.valorUnitario || prod.valor_unitario || 0
                    }))
                });
                valorTotalCaixa += nfe.valorTotal;
            });
            
            // Criar dados para o QR Code da Caixa
            const qrData = {
                caixaId: `CAIXA${Date.now()}`,
                nfeSelecionadas: nfeSelecionadas,
                valorTotalCaixa: valorTotalCaixa,
                dataGeracao: new Date().toLocaleDateString('pt-BR')
            };
            
            const qrDataString = JSON.stringify(qrData);
            
            // Gerar QR Code
            const qrContainer = document.getElementById('qrcodeCaixa');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: qrDataString,
                width: 200,
                height: 200
            });
            
            document.getElementById('qrCaixaInfo').textContent = `QR Code gerado para ${nfeSelecionadas.length} NFes - Valor Total: R$ ${valorTotalCaixa.toFixed(2)}`;
            document.getElementById('downloadQrCaixa').style.display = 'inline-block';
            
            // Configurar download do QR Code
            document.getElementById('downloadQrCaixa').onclick = function() {
                const canvas = qrContainer.querySelector('canvas');
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `qrcode-caixa-${qrData.caixaId}.png`;
                link.href = url;
                link.click();
            };
            
            showNotification('QR Code da Caixa gerado com sucesso!');
        });

        // Inicializar a página
        document.addEventListener('DOMContentLoaded', function() {
            atualizarListaNFe();
            atualizarSelectNFe();
            atualizarCaixaNFeList();
        });
    </script>
</body>
</html>